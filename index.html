<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CadenceFlow - Sales Outreach Automation</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar - Component Palette -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Components</h3>
            </div>
            
            <div class="component-category">
                <h4>Workflow Components</h4>
                <div class="component-item" draggable="true" data-type="start">
                    <i class="fas fa-play"></i>
                    <span>Start</span>
                </div>
                <div class="component-item" draggable="true" data-type="email">
                    <i class="fas fa-envelope"></i>
                    <span>Email</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Header -->
            <div class="header">
                <div class="header-left">
                    <h2>CadenceFlow</h2>
                    <div class="nav-tabs" style="display: none;" id="navTabs">
                        <button class="nav-tab active" data-view="builder">
                            <i class="fas fa-project-diagram"></i> Builder
                        </button>
                        <button class="nav-tab" data-view="cadences">
                            <i class="fas fa-list-ul"></i> Cadences
                        </button>
                        <button class="nav-tab" data-view="contacts">
                            <i class="fas fa-users"></i> Contacts
                        </button>
                    </div>
                </div>
            <div class="header-actions">
                <button class="btn btn-secondary" id="loginBtn">
                    <i class="fab fa-google"></i> Login with Google
                </button>
                <span id="userEmail" style="display: none; margin-right: 15px; color: #666; font-size: 14px;"></span>
                <button class="btn btn-tech" id="saveCadenceBtn" style="display: none;">
                    <i class="fas fa-save"></i>
                    <span>Save</span>
                </button>
                <button class="btn btn-tech" id="loadCadenceBtn" style="display: none;">
                    <i class="fas fa-folder-open"></i>
                    <span>Load</span>
                </button>
                <button class="btn btn-primary" id="runWorkflowBtn" style="display: none;">
                    <i class="fas fa-play"></i> Start Flow
                </button>
            </div>
            </div>
            
            <!-- Workflow Canvas (Builder View) -->
            <div class="workflow-canvas view-content" id="workflowCanvas" data-view="builder">
                <div class="canvas-grid"></div>
                
                <!-- SVG for connection lines -->
                <svg class="connections-svg" id="connectionsSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6" />
                        </marker>
                    </defs>
                </svg>
                
                <div class="workflow-nodes" id="workflowNodes">
                    <!-- Workflow nodes will be added here -->
                </div>

                <div class="canvas-controls">
                    <button class="control-btn" id="zoomIn">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="control-btn" id="zoomOut">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="control-btn" id="undo">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="control-btn" id="redo">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="control-btn" id="refresh">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            
            <!-- Cadences View -->
            <div class="view-content" id="cadencesView" data-view="cadences" style="display: none; padding: 40px; overflow-y: auto;">
                <div style="max-width: 1200px; margin: 0 auto;">
                    <h2 style="margin-bottom: 30px; font-size: 28px; color: #1f2937;">
                        <i class="fas fa-list-ul"></i> Your Cadences
                    </h2>
                    <div id="cadencesList"></div>
                </div>
            </div>
            
            <!-- Contacts View -->
            <div class="view-content" id="contactsView" data-view="contacts" style="display: none; padding: 40px; overflow-y: auto;">
                <div style="max-width: 1200px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="margin: 0; font-size: 28px; color: #1f2937;">
                            <i class="fas fa-users"></i> Your Contacts
                        </h2>
                        <button class="btn btn-primary" id="refreshContactsBtn">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div id="contactsList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Store token globally BEFORE script.js loads
        window._authToken = localStorage.getItem('authToken');
        
        // Handle OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        if (urlToken) {
            localStorage.setItem('authToken', urlToken);
            window._authToken = urlToken;
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Broadcast to extension immediately
            broadcastTokenToExtension(urlToken);
        }
        
        // Broadcast existing token on page load
        if (window._authToken) {
            broadcastTokenToExtension(window._authToken);
        }
        
        // Function to broadcast token to extension
        function broadcastTokenToExtension(token) {
            // Method 1: Post message to window (extension content script can listen)
            window.postMessage({ 
                type: 'CADENCEFLOW_AUTH_TOKEN', 
                token: token 
            }, '*');
            
            // Method 2: Store in a way content script can access
            window.CADENCEFLOW_TOKEN = token;
            
            console.log('ðŸ“¡ Token broadcasted to extension');
        }
    </script>
    <script src="script.js"></script>
    <script>
        // After script.js loads, set up auth UI
        (function() {
            const token = window._authToken;
            
            // Add event listeners for buttons
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    window.location.href = 'http://localhost:3000/auth/google';
                });
            }

            if (token) {
                // Verify token
                fetch('http://localhost:3000/api/user', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(res => {
                    if (!res.ok) throw new Error('Invalid token');
                    return res.json();
                })
                .then(user => {
                    // Show logged in UI
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('userEmail').style.display = 'inline-block';
                    document.getElementById('navTabs').style.display = 'flex';
                    document.getElementById('saveCadenceBtn').style.display = 'inline-block';
                    document.getElementById('loadCadenceBtn').style.display = 'inline-block';
                    document.getElementById('runWorkflowBtn').style.display = 'inline-block';
                    console.log('âœ… Logged in as:', user.email);
                })
                .catch(() => {
                    localStorage.removeItem('authToken');
                    window._authToken = null;
                    location.reload();
                });
            }
        })();
    </script>
</body>
</html>
