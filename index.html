<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CadenceFlow - Sales Outreach Automation</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar - Component Palette -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Components</h3>
            </div>
            
            <div class="component-category">
                <h4>Workflow Components</h4>
                <div class="component-item" draggable="true" data-type="start">
                    <i class="fas fa-play"></i>
                    <span>Start</span>
                </div>
                <div class="component-item" draggable="true" data-type="email">
                    <i class="fas fa-envelope"></i>
                    <span>Email</span>
                </div>
                <div class="component-item" draggable="true" data-type="end">
                    <i class="fas fa-stop"></i>
                    <span>End</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Header -->
            <div class="header">
                <div class="header-left">
                    <h2>New workflow</h2>
                    <span class="status-badge">Draft</span>
                </div>
            <div class="header-actions">
                <button class="btn btn-secondary" id="loginBtn" onclick="window.location.href='http://localhost:3000/auth/google'">Login with Google</button>
                <span id="userEmail" style="display: none; margin-right: 15px; color: #666; font-size: 14px;"></span>
                <button class="btn btn-secondary" id="saveCadenceBtn" style="display: none;">üíæ Save Cadence</button>
                <button class="btn btn-secondary" id="loadCadenceBtn" style="display: none;">üìÇ Load Cadence</button>
                <button class="btn btn-primary" id="runWorkflowBtn" style="display: none;">‚ñ∂Ô∏è Start Flow</button>
            </div>
            </div>
            
            <!-- Workflow Canvas -->
            <div class="workflow-canvas" id="workflowCanvas">
                <div class="canvas-grid"></div>
                
                <!-- SVG for connection lines -->
                <svg class="connections-svg" id="connectionsSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6" />
                        </marker>
                    </defs>
                </svg>
                
                <div class="workflow-nodes" id="workflowNodes">
                    <!-- Workflow nodes will be added here -->
                </div>
                
                <!-- Connection Instructions -->
                <div class="connection-instructions" id="connectionInstructions">
                    <div class="instruction-content">
                        <h4>How to Connect Nodes:</h4>
                        <p>1. <strong>Click and drag</strong> from any blue dot on a node</p>
                        <p>2. <strong>Drag to any blue dot</strong> on another node to connect them</p>
                        <p>3. <strong>Release</strong> to create the connection</p>
                        <button onclick="this.parentElement.parentElement.style.display='none'">Got it!</button>
                    </div>
                </div>
                
                <div class="canvas-controls">
                    <button class="control-btn" id="zoomIn">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="control-btn" id="zoomOut">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="control-btn" id="undo">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="control-btn" id="redo">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="control-btn" id="refresh">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Right Configuration Panel -->
        <div class="config-panel" id="configPanel">
            <div class="config-header">
                <h3 id="configTitle">Select a node to configure</h3>
                <button class="close-config" id="closeConfig">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="config-content" id="configContent">
                <p>Click on a workflow node to configure its properties.</p>
            </div>
        </div>
    </div>
    
    <script>
        // Store token globally BEFORE script.js loads
        window._authToken = localStorage.getItem('authToken');
        
        // Handle OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        if (urlToken) {
            localStorage.setItem('authToken', urlToken);
            window._authToken = urlToken;
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
    <script src="script.js"></script>
    <script>
        // After script.js loads, set up auth UI
        (function() {
            const token = window._authToken;
            
            if (token) {
                // Verify token
                fetch('http://localhost:3000/api/user', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(res => {
                    if (!res.ok) throw new Error('Invalid token');
                    return res.json();
                })
                .then(user => {
                    // Show logged in UI
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('userEmail').style.display = 'inline-block';
                    document.getElementById('saveCadenceBtn').style.display = 'inline-block';
                    document.getElementById('loadCadenceBtn').style.display = 'inline-block';
                    document.getElementById('runWorkflowBtn').style.display = 'inline-block';
                    console.log('‚úÖ Logged in as:', user.email);
                })
                .catch(() => {
                    localStorage.removeItem('authToken');
                    window._authToken = null;
                    location.reload();
                });
            }
        })();
    </script>
</body>
</html>
